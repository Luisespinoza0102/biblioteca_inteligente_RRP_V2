{% extends 'base.html' %}

{% block content %}
<div class="p-6 bg-[#0f172a] min-h-screen text-slate-200">
    <div class="flex items-center gap-4 mb-8">
        <div class="p-3 bg-blue-600 rounded-xl shadow-lg shadow-blue-900/40">
            <i class="fas fa-book-medical text-xl text-white"></i>
        </div>
        <div>
            <h2 class="text-2xl font-bold text-white">{{ titulo }}</h2>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Registro de obra intelectual</p>
        </div>
    </div>

    <div class="max-w-6xl bg-slate-800/30 border border-slate-800 p-8 rounded-3xl shadow-2xl backdrop-blur-sm">
        <form method="post" enctype="multipart/form-data" class="space-y-8">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                
                <div class="space-y-6">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <i class="fas fa-heading text-blue-500 text-[10px]"></i> Título del Libro
                        </label>
                        {{ form.titulo }}
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <i class="fas fa-fingerprint text-blue-500 text-[10px]"></i> Código Cutter
                        </label>
                        {{ form.cutter }}
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <i class="fas fa-align-left text-blue-500 text-[10px]"></i> Sinopsis / Descripción
                        </label>
                        {{ form.descripcion }}
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <i class="fas fa-image text-blue-500 text-[10px]"></i> Portada del Libro
                        </label>
                        <div onclick="document.getElementById('input-portada').click()" 
                             class="border-2 border-dashed border-slate-700 rounded-3xl h-[280px] flex flex-col items-center justify-center hover:border-blue-500/50 hover:bg-blue-500/5 transition-all cursor-pointer bg-slate-900/40 group relative overflow-hidden shadow-inner">
                            
                            <div id="preview-container" class="text-center group-hover:scale-110 transition duration-500">
                                <i class="fas fa-cloud-upload-alt text-4xl text-slate-600 mb-3 group-hover:text-blue-400"></i>
                                <p class="text-sm text-slate-500 group-hover:text-slate-300">Seleccionar archivo</p>
                                <p class="text-[9px] text-slate-600 mt-1 uppercase tracking-tighter">PNG, JPG (Máx 2MB)</p>
                            </div>
                            
                            <img id="img-preview" class="hidden absolute inset-0 w-full h-full object-cover rounded-2xl">
                            
                            <div class="hidden">{{ form.imagen_portada }}</div>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-widest flex justify-between">
                        <span><i class="fas fa-users text-blue-500 mr-1"></i> Autores</span>
                        <span class="text-blue-500 text-[9px] lowercase opacity-60">Mantén Ctrl para varios</span>
                    </label>
                    <div class="flex gap-3">
                        <div class="flex-grow select-dark-wrapper">
                            {{ form.autores }}
                        </div>
                        <button type="button" onclick="openModal('modalAutor')" class="bg-slate-900 border border-slate-700 text-blue-400 px-5 rounded-xl hover:bg-blue-600 hover:text-white transition-all shadow-lg self-start py-4">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-widest flex justify-between">
                        <span><i class="fas fa-tags text-blue-500 mr-1"></i> Clasificación Dewey</span>
                        <span class="text-blue-500 text-[9px] lowercase opacity-60">Usa Ctrl + Clic</span>
                    </label>
                    <div class="flex gap-3">
                        <div class="flex-grow select-dark-wrapper">
                            {{ form.generos }}
                        </div>
                        <button type="button" onclick="openModal('modalDewey')" class="bg-slate-900 border border-slate-700 text-blue-400 px-5 rounded-xl hover:bg-blue-600 hover:text-white transition-all shadow-lg self-start py-4">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between border-t border-slate-800 pt-8 mt-10">
                <a href="{% url 'gestion_libros' %}" class="text-sm font-bold text-slate-500 hover:text-white transition uppercase tracking-widest">
                    <i class="fas fa-arrow-left mr-2"></i> Volver al listado
                </a>
                <div class="flex gap-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white px-12 py-4 rounded-2xl font-bold shadow-xl shadow-blue-900/40 transition-all flex items-center gap-3 active:scale-95">
                        <i class="fas fa-save"></i> Guardar Obra
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="modalAutor" class="hidden fixed inset-0 bg-[#020617]/90 backdrop-blur-md flex items-center justify-center z-50">
    <div class="bg-slate-900 p-8 rounded-3xl w-full max-w-md border border-slate-800 shadow-2xl">
        <div class="flex items-center gap-3 mb-6">
            <div class="p-2 bg-blue-600/20 rounded-lg"><i class="fas fa-user-plus text-blue-500"></i></div>
            <h3 class="text-xl font-bold text-white">Nuevo Autor</h3>
        </div>
        <input type="text" id="inputNombreAutor" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-4 text-white mb-6 outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Nombre completo">
        <div class="flex justify-end gap-4">
            <button type="button" onclick="closeModal('modalAutor')" class="text-slate-500 font-bold text-xs uppercase hover:text-white transition">Cancelar</button>
            <button type="button" onclick="saveQuick('autor')" class="bg-blue-600 px-8 py-3 rounded-xl font-bold text-white hover:bg-blue-500 transition shadow-lg shadow-blue-900/20">Registrar</button>
        </div>
    </div>
</div>

<div id="modalDewey" class="hidden fixed inset-0 bg-[#020617]/90 backdrop-blur-md flex items-center justify-center z-50">
    <div class="bg-slate-900 p-8 rounded-3xl w-full max-w-md border border-slate-800 shadow-2xl">
        <div class="flex items-center gap-3 mb-6">
            <div class="p-2 bg-blue-600/20 rounded-lg"><i class="fas fa-tags text-blue-500"></i></div>
            <h3 class="text-xl font-bold text-white">Sistema Dewey</h3>
        </div>
        <div class="space-y-4 mb-6">
            <input type="text" id="inputDeweyCod" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Código (Ej: 800)">
            <input type="text" id="inputDeweyNom" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Género (Ej: Literatura)">
        </div>
        <div class="flex justify-end gap-4">
            <button type="button" onclick="closeModal('modalDewey')" class="text-slate-500 font-bold text-xs uppercase hover:text-white transition">Cancelar</button>
            <button type="button" onclick="saveQuick('genero')" class="bg-blue-600 px-8 py-3 rounded-xl font-bold text-white hover:bg-blue-500 transition shadow-lg shadow-blue-900/20">Registrar</button>
        </div>
    </div>
</div>

<style>
    /* Estilos para los campos de Django {{ form.xxx }} */
    input[type="text"], textarea, select[multiple] {
        width: 100%;
        background: rgba(2, 6, 23, 0.5) !important;
        border: 1px solid #1e293b !important;
        border-radius: 1rem !important;
        padding: 1rem !important;
        color: white !important;
        outline: none !important;
        transition: all 0.3s !important;
    }
    input[type="text"]:focus, textarea:focus, select[multiple]:focus {
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1) !important;
        background: rgba(2, 6, 23, 0.8) !important;
    }
    textarea { min-height: 120px; resize: none; }
    
    /* Scrollbar personalizada para selects múltiples */
    select[multiple]::-webkit-scrollbar { width: 6px; }
    select[multiple]::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
</style>

<script>
    // 1. Manejo de Modales
    function openModal(id) { 
        document.getElementById(id).classList.remove('hidden');
    }
    function closeModal(id) { 
        document.getElementById(id).classList.add('hidden'); 
    }

    // 2. Previsualización de Imagen
    const inputPortada = document.querySelector('input[type="file"]');
    if(inputPortada) {
        inputPortada.id = 'input-portada'; 
        inputPortada.onchange = evt => {
            const [file] = inputPortada.files;
            if (file) {
                const preview = document.getElementById('img-preview');
                const container = document.getElementById('preview-container');
                preview.src = URL.createObjectURL(file);
                preview.classList.remove('hidden');
                container.classList.add('opacity-0');
            }
        }
    }

    // 3. Guardado Rápido AJAX (Autor y Género)
    async function saveQuick(tipo) {
        let payload = {};
        let url = (tipo === 'autor') ? "{% url 'api_crear_autor' %}" : "{% url 'api_crear_genero' %}";

        if (tipo === 'autor') {
            const nombre = document.getElementById('inputNombreAutor').value;
            if(!nombre) return alert("El nombre es obligatorio");
            payload = { nombre: nombre };
        } else {
            const nombre = document.getElementById('inputDeweyNom').value;
            const dewey = document.getElementById('inputDeweyCod').value;
            if(!nombre || !dewey) return alert("Ambos campos son obligatorios");
            payload = { nombre: nombre, dewey: dewey };
        }

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.id) {
                // El ID del select que genera Django suele ser id_nombreDelCampo
                const selectId = tipo === 'autor' ? 'id_autores' : 'id_generos';
                const select = document.getElementById(selectId);
                
                if (select) {
                    const newOption = new Option(data.nombre, data.id, true, true);
                    select.add(newOption);
                }
                
                closeModal(tipo === 'autor' ? 'modalAutor' : 'modalDewey');
                
                // Limpiar inputs
                if(tipo === 'autor') {
                    document.getElementById('inputNombreAutor').value = '';
                } else {
                    document.getElementById('inputDeweyNom').value = '';
                    document.getElementById('inputDeweyCod').value = '';
                }
            } else {
                alert("Error: " + (data.error || "No se pudo guardar"));
            }
        } catch (error) {
            console.error("Error en la petición:", error);
            alert("Error crítico en el servidor.");
        }
    }
</script>
{% endblock %}